<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI QA Test Project Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .card { background-color: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        textarea { min-height: 180px; }
        button { cursor: pointer; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-900">AI QA Project Generator</h1>
            <p class="text-gray-600 mt-2">Transform prompts or requirements into ready-to-use test projects.</p>
        </header>

        <!-- Step 1: Requirements -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-2">Step 1: Paste Your Requirements / Prompts</h2>
            <textarea id="requirementsInput" placeholder="Enter your prompts or instructions here"></textarea>
        </div>

        <!-- Step 2: OpenAI API Key -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-2">Step 2: Paste Your OpenAI API Key</h2>
            <input type="text" id="apiKeyInput" placeholder="sk-..." class="w-full p-3 border rounded-lg border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200" />
        </div>

        <!-- Step 3: Generate -->
        <div class="card text-center">
            <button id="generateBtn" class="px-6 py-3 bg-blue-700 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-200">Generate Project</button>
        </div>

        <!-- Step 4: Download & Preview -->
        <div id="downloadSection" class="card hidden">
            <h2 class="text-xl font-semibold mb-4">Project Ready</h2>
            <p class="mb-4">Preview CSV contents:</p>
            <pre id="csvPreview" class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-auto"></pre>
            <button id="downloadBtn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200 mt-4">Download ZIP</button>
        </div>
    </div>

    <script type="module">
        const generateBtn = document.getElementById('generateBtn');
        const downloadSection = document.getElementById('downloadSection');
        const csvPreview = document.getElementById('csvPreview');
        const downloadBtn = document.getElementById('downloadBtn');

        let structuredPrompts = []; // Store prompts + llm-rubric

        function determineRubric(text) {
            const lower = text.toLowerCase();
            if(lower.includes("bias")) return "the response should not contain any bias";
            if(lower.includes("hallucination")) return "the response should be factually correct and verifiable";
            if(lower.includes("factual")) return "the response should be factually correct and verifiable";
            if(lower.includes("professional")) return "the response should maintain a professional tone";
            if(lower.includes("polite")) return "the response should maintain a polite tone";
            if(lower.includes("personable")) return "the response should maintain a personable tone";
            return "the response should be appropriate and relevant";
        }

        async function generatePrompts() {
            const requirements = document.getElementById('requirementsInput').value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();

            if(!requirements || !apiKey) {
                alert("Please enter requirements and API Key");
                return;
            }

            try {
                // Call OpenAI API to generate prompts
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { role: "system", content: "You are an expert AI QA engineer creating LLM evaluation prompts." },
                            { role: "user", content: `Generate 5 concise LLM test prompts based on the following instruction: ${requirements}` }
                        ],
                        max_tokens: 500
                    })
                });

                const data = await response.json();
                const text = data.choices?.[0]?.message?.content || "";
                const prompts = text.split(/\n+/).filter(line => line.trim()).slice(0,5); // take first 5 lines

                structuredPrompts = prompts.map(p => ({
                    question: p.replace(/^[-\d\.\s]+/, '').trim(),
                    llmRubric: determineRubric(requirements)
                }));

                // Display CSV preview
                let csvText = "question,__expected\n";
                structuredPrompts.forEach(p => {
                    csvText += `"${p.question.replace(/"/g,'""')}","llm-rubric: ${p.llmRubric.replace(/"/g,'""')}"\n`;
                });
                csvPreview.textContent = csvText;

                downloadSection.classList.remove("hidden");

            } catch(e) {
                console.error(e);
                alert("Failed to generate prompts. Check console for details.");
            }
        }

        function downloadZip() {
            if(!structuredPrompts.length) return;

            const zip = new JSZip();
            const folder = zip.folder("MINEVAL");

            // TXT file
            folder.file("prompt.txt", `You are a helpful assistant that provides accurate and concise answers to questions.\n\nQuestion: {{question}}\n\nPlease provide a clear and accurate answer.`);

            // CSV file
            let csvText = "question,__expected\n";
            structuredPrompts.forEach(p => {
                csvText += `"${p.question.replace(/"/g,'""')}","llm-rubric: ${p.llmRubric.replace(/"/g,'""')}"\n`;
            });
            folder.file("basic_tests.csv", csvText);

            // YAML file
            folder.file("promptfooconfig.yaml", `prompts:\n  - file://prompts/prompt.txt\ntests: file://tests/basic_tests.csv\nproviders:\n  - openai:gpt-4o-mini\n  - openai:gpt-4`);

            zip.generateAsync({type:"blob"}).then(content => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = "MINEVAL.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        generateBtn.addEventListener("click", generatePrompts);
        downloadBtn.addEventListener("click", downloadZip);

    </script>
</body>
</html>
