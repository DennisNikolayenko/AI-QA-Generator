<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI QA Project Generator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
  textarea, input { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.5rem; }
  button { margin-top: 1rem; background-color: #2563eb; color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; cursor: pointer; }
  button:hover { background-color: #1d4ed8; }
  .category-header { cursor: pointer; font-weight: bold; color: #1e40af; margin-top: 1rem; }
  .category-content { display: none; white-space: pre; background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; }
  #downloadBtn { background-color: #16a34a; }
  #downloadBtn:hover { background-color: #15803d; }
</style>
</head>
<body>

<div class="max-w-4xl mx-auto p-6 mt-10 bg-white shadow-lg rounded">
  <h1 class="text-3xl font-bold mb-4">AI QA Project Generator</h1>

  <!-- Input Section -->
  <label class="font-semibold">Paste your requirements / prompts:</label>
  <textarea id="requirementsInput" placeholder="Enter one requirement per line..."></textarea>

  <label class="font-semibold mt-2">OpenAI API Key:</label>
  <input type="password" id="apiKeyInput" placeholder="sk-...">

  <button onclick="generateProject()">Generate Project</button>

  <!-- Status -->
  <div id="status" class="mt-4 text-green-600 font-semibold"></div>

  <!-- Preview -->
  <div id="preview" class="mt-6"></div>

  <!-- Download -->
  <button id="downloadBtn" class="mt-6" style="display:none" onclick="downloadZip()">Download Project ZIP</button>
</div>

<script>
const CATEGORIES = ['Bias', 'Factuality', 'Compliance', 'UX'];
let structuredData = null;
let zipProject = null;

// --- Generate Project ---
async function generateProject() {
  const inputText = document.getElementById('requirementsInput').value.trim();
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  const status = document.getElementById('status');
  const preview = document.getElementById('preview');
  const downloadBtn = document.getElementById('downloadBtn');

  preview.innerHTML = '';
  status.textContent = '';
  downloadBtn.style.display = 'none';
  zipProject = new JSZip();

  if (!inputText) { alert('Enter requirements!'); return; }
  if (!apiKey) { alert('Enter your OpenAI API Key!'); return; }

  status.textContent = 'Generating project...';

  // --- Prepare OpenAI request ---
  const lines = inputText.split('\n').filter(l => l.trim() !== '');
  structuredData = {};
  CATEGORIES.forEach(c => structuredData[c] = []);

  // Call OpenAI API for each line (basic example using GPT-4o-mini)
  for (let line of lines) {
    const prompt = `
You are an AI QA engineer. Categorize the following requirement into one of the categories: ${CATEGORIES.join(', ')}.
Then, generate a test CSV row in this format:
question,__expected,__expected2

Requirement: "${line}"
CSV Row:
`;
    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [{role: "user", content: prompt}],
          temperature: 0.3
        })
      });
      const data = await response.json();
      let text = data.choices?.[0]?.message?.content?.trim();
      if (!text) text = `"${line}","icontains: sample","llm-rubric: sample"`;

      // Extract category (first word before comma in CSV)
      const cat = CATEGORIES.find(c => text.toLowerCase().includes(c.toLowerCase())) || 'Factuality';
      structuredData[cat].push(text);

    } catch (err) {
      console.error(err);
      structuredData['Factuality'].push(`"${line}","icontains: sample","llm-rubric: sample"`);
    }
  }

  status.textContent = 'Preview generated!';
  renderPreview();
  downloadBtn.style.display = 'inline-block';
}

// --- Render Preview ---
function renderPreview() {
  const preview = document.getElementById('preview');
  preview.innerHTML = '';
  for (let cat of CATEGORIES) {
    if (!structuredData[cat] || structuredData[cat].length === 0) continue;
    const header = document.createElement('div');
    header.textContent = `${cat} (${structuredData[cat].length} items)`;
    header.className = 'category-header';
    header.onclick = () => content.style.display = content.style.display === 'none' ? 'block' : 'none';
    const content = document.createElement('div');
    content.className = 'category-content';
    content.textContent = structuredData[cat].join('\n');

    preview.appendChild(header);
    preview.appendChild(content);
  }
}

// --- Generate ZIP ---
function downloadZip() {
  if (!structuredData) return;

  const root = zipProject.folder("MINEVAL");

  for (let cat of CATEGORIES) {
    const catFolder = root.folder(cat);
    const promptsFolder = catFolder.folder("prompts");
    const testsFolder = catFolder.folder("tests");

    // prompt.txt
    promptsFolder.file("prompt.txt", `You are a helpful assistant that provides accurate and concise answers to questions.\n\nQuestion: {{question}}\n\nPlease provide a clear and accurate answer.`);

    // tests CSV
    let csvContent = 'question,__expected,__expected2\n';
    for (let row of structuredData[cat]) csvContent += row + '\n';
    testsFolder.file("basic_tests.csv", csvContent);

    // YAML
    const yamlContent = `prompts:\n  - file://prompts/prompt.txt\ntests:\n  - file://tests/basic_tests.csv\nproviders:\n  - openai:gpt-4o-mini\n  - openai:gpt-4\n`;
    catFolder.file("promptfooconfig.yaml", yamlContent);
  }

  zipProject.generateAsync({type:"blob"}).then(function(content) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(content);
    a.download = "MINEVAL.zip";
    a.click();
  });
}
</script>

</body>
</html>
