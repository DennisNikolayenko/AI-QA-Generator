<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI QA Project Generator</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body { font-family: 'Inter', sans-serif; background-color: #f9fafb; min-height: 100vh; padding: 2rem; }
.card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; }
textarea { resize: vertical; min-height: 200px; }
button { cursor: pointer; }
.loading-spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #1e3a8a; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
.loading-spinner.active { display: inline-block; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="max-w-4xl mx-auto">

  <header class="text-center mb-8">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">AI QA Project Generator</h1>
    <p class="text-gray-500">Convert raw requirements into a structured, ready-to-use project.</p>
  </header>

  <!-- Input Section -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-2">Step 1: Paste Your Requirements / Prompts</h2>
    <textarea id="requirementsInput" placeholder="Paste your prompts or test requirements here..."></textarea>

    <h2 class="text-xl font-semibold mt-4 mb-2">Step 2: Paste Your OpenAI API Key</h2>
    <input type="text" id="apiKeyInput" class="w-full p-2 border border-gray-300 rounded" placeholder="sk-...">

    <button id="generateButton" class="mt-4 w-full bg-blue-600 text-white py-3 rounded font-semibold flex items-center justify-center">
      <span id="buttonText">Generate Project</span>
      <div id="loadingSpinner" class="loading-spinner ml-3"></div>
    </button>

    <p id="errorMessage" class="text-red-600 mt-2 hidden"></p>
  </div>

  <!-- Preview Section -->
  <div id="previewCard" class="card hidden">
    <h2 class="text-xl font-semibold mb-2">CSV Preview</h2>
    <pre id="csvPreview" class="bg-gray-100 p-3 rounded overflow-x-auto text-sm"></pre>
  </div>

  <!-- Download Section -->
  <div id="downloadCard" class="card hidden">
    <button id="downloadButton" class="w-full bg-green-600 text-white py-3 rounded font-semibold">Download Project (.zip)</button>
  </div>
</div>

<script>
function escapeCSV(text) {
  const escaped = text.replace(/"/g, '""');
  return `"${escaped}"`;
}

function showLoading(isLoading) {
  const spinner = document.getElementById('loadingSpinner');
  const buttonText = document.getElementById('buttonText');
  const button = document.getElementById('generateButton');
  spinner.classList.toggle('active', isLoading);
  buttonText.textContent = isLoading ? 'Generating...' : 'Generate Project';
  button.disabled = isLoading;
}

function displayError(msg) {
  const errorEl = document.getElementById('errorMessage');
  errorEl.textContent = msg;
  errorEl.classList.remove('hidden');
}

async function generateProject() {
  const requirements = document.getElementById('requirementsInput').value.trim();
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!requirements) { displayError('Please paste your requirements.'); return; }
  if (!apiKey) { displayError('Please provide your OpenAI API key.'); return; }
  document.getElementById('errorMessage').classList.add('hidden');
  showLoading(true);

  try {
    // Call OpenAI API for LLM evaluation
    const payload = {
      model: "gpt-4o-mini",
      messages: [{ role: "system", content: "Convert user text into a structured list of questions for CSV with icontains and llm-rubric." },
                 { role: "user", content: requirements }],
      temperature: 0.3
    };

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    const text = data.choices?.[0]?.message?.content || "";
    if (!text) throw new Error("No response from API");

    // Split text into lines for questions
    const questions = text.split("\n").filter(q => q.trim().length > 0);

    // Generate CSV content
    let csv = 'question,__expected,__expected2\n';
    const rows = questions.map(q => {
      return `${escapeCSV(q)},"icontains: ...","llm-rubric: answer should be factually correct"`;
    });
    csv += rows.join("\n");

    // Preview
    document.getElementById('csvPreview').textContent = csv;
    document.getElementById('previewCard').classList.remove('hidden');

    // Generate ZIP
    const zip = new JSZip();
    const root = zip.folder("MINEVAL");
    root.file("basic_tests.csv", csv);
    root.file("prompts.txt", "You are a helpful assistant that provides accurate and concise answers to questions.\n\nQuestion: {{question}}\n\nPlease provide a clear and accurate answer.");
    root.file("promptfooconfig.yaml", `prompts:\n  - file://prompts.txt\ntests:\n  - file://basic_tests.csv\nproviders:\n  - openai:gpt-4o-mini\n  - openai:gpt-4`);

    document.getElementById('downloadCard').classList.remove('hidden');

    document.getElementById('downloadButton').onclick = () => {
      zip.generateAsync({type: "blob"}).then(content => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = "MINEVAL.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    };

  } catch (err) {
    console.error(err);
    displayError("Error generating project. Check console.");
  } finally {
    showLoading(false);
  }
}

document.getElementById('generateButton').addEventListener('click', generateProject);
</script>
</body>
</html>
