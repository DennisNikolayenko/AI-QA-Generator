<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Project Artifact Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">LLM Project Artifact Generator</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Input Card (Updated) -->
            <div class="card p-6 rounded-xl col-span-2 space-y-5">
                
                <!-- NEW: Gemini API Key Input -->
                <div class="space-y-2">
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Paste your Gemini API Key here (starts with 'AIza...')" />
                </div>
                
                <div class="space-y-2">
                    <label for="promptInput" class="block text-sm font-medium text-gray-700">Project Prompt / Goal</label>
                    <textarea id="promptInput" rows="7" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., Generate a test project for a financial AI assistant."></textarea>
                </div>

                <!-- Removed System Instruction Input -->
            </div>
            
            <!-- Actions/Output Card -->
            <div class="card p-6 rounded-xl space-y-5">
                <h2 class="text-xl font-semibold text-gray-800">Actions & Status</h2>

                <button id="analyzeButton" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50" onclick="handleAnalyzeProject()">
                    <span id="buttonText">Analyze & Structure Project</span>
                    <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                </button>

                <div id="statusMessage" class="min-h-12 p-3 text-sm rounded-lg border hidden transition duration-300"></div>
            </div>
        </div>

        <!-- NEW SECTION 2: Generated Project Structure -->
        <div id="section2" class="card p-6 rounded-xl mt-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Generated Project Structure</h2>
            
            <p id="totalArtifactsSummary" class="font-bold text-lg text-gray-700 mb-4">Total Artifacts Generated: 0</p>

            <div id="categoryList" class="space-y-3">
                <!-- Categories will be rendered here by JavaScript -->
            </div>

            <div class="space-y-2 pt-6">
                <label class="block text-sm font-medium text-gray-700">Raw Output Detail</label>
                <!-- Raw output display, now used as a fallback/detail view -->
                <pre id="outputContent" class="bg-gray-50 p-3 h-40 overflow-auto border border-gray-200 rounded-lg text-xs whitespace-pre-wrap"></pre>
            </div>
            
            <button id="downloadButton" class="w-full mt-5 py-3 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 disabled:opacity-50" disabled onclick="downloadArtifacts()">Download Project (ZIP)</button>
        </div>
    </div>

    <script>
        // Global constant for the model
        const GENERATION_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // --- FIXED TEST CATEGORIES (As requested) ---
        const TEST_CATEGORIES = [
            'domain-and-financial-factuality',
            'regulatory-compliance-adherence',
            'data-privacy-security',
            'customer-service-empathy'
        ];
        
        // --- DOM ELEMENTS ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const promptInput = document.getElementById('promptInput');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');
        const outputContent = document.getElementById('outputContent');
        const downloadButton = document.getElementById('downloadButton');
        const categoryList = document.getElementById('categoryList');
        const totalArtifactsSummary = document.getElementById('totalArtifactsSummary');
        const section2 = document.getElementById('section2');

        let generatedArtifacts = null; // Stores the LLM's JSON output

        // --- UI FUNCTIONS ---

        function showLoading(isLoading) {
            analyzeButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Analyzing...' : 'Analyze & Structure Project';
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-300', 'bg-green-100', 'text-green-700', 'border-green-300', 'bg-blue-100', 'text-blue-700', 'border-blue-300');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            } else {
                statusMessage.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }
        }

        function updateOutput(content) {
            outputContent.textContent = content;
        }

        function renderProjectStructure(data) {
            let totalArtifacts = 0;
            categoryList.innerHTML = ''; // Clear previous content

            TEST_CATEGORIES.forEach(category => {
                const artifacts = data[category] || [];
                const artifactCount = artifacts.length;
                totalArtifacts += artifactCount;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'p-3 bg-white border border-gray-200 rounded-lg flex justify-between items-center cursor-pointer hover:bg-indigo-50 transition duration-150';
                categoryDiv.innerHTML = `
                    <span class="font-medium text-gray-700">${category}</span>
                    <span class="text-indigo-600 font-bold">${artifactCount} Artifacts</span>
                `;
                // Simple console log for click, as we don't have detail view functionality
                categoryDiv.onclick = () => console.log(`Details for: ${category}\n`, artifacts);
                categoryList.appendChild(categoryDiv);
            });

            totalArtifactsSummary.textContent = `Total Artifacts Generated: ${totalArtifacts}`;
            section2.classList.remove('hidden');
        }

        function hideProjectStructure() {
            section2.classList.add('hidden');
            categoryList.innerHTML = '';
            totalArtifactsSummary.textContent = 'Total Artifacts Generated: 0';
        }


        // --- CORE LOGIC ---

        async function handleAnalyzeProject() {
            const prompt = promptInput.value.trim();
            const apiKey = apiKeyInput.value.trim(); // Read the API Key

            if (!apiKey) {
                showStatus('Please enter your Gemini API Key to run the analysis.', 'error');
                return;
            }

            if (!prompt) {
                showStatus('Please enter a project prompt/goal.', 'error');
                return;
            }

            // Construct API URL with user-provided key
            const API_URL_WITH_KEY = `https://generativelanguage.googleapis.com/v1beta/models/${GENERATION_MODEL}:generateContent?key=${apiKey}`;
            
            showLoading(true);
            updateOutput('Awaiting response from Gemini...');
            downloadButton.disabled = true;
            hideProjectStructure(); // Hide previous structure

            
            // Define the JSON schema for the desired output 
            // The structure is now based on the fixed TEST_CATEGORIES
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    'domain-and-financial-factuality': { 
                        type: "ARRAY", 
                        items: { type: "OBJECT", properties: { filename: { type: "STRING" }, content: { type: "STRING" } } },
                        description: "List of generated files (e.g., promptfooconfig.yaml, prompt.txt, tests.csv) related to this domain."
                    },
                    'regulatory-compliance-adherence': { 
                        type: "ARRAY", 
                        items: { type: "OBJECT", properties: { filename: { type: "STRING" }, content: { type: "STRING" } } },
                        description: "List of generated files related to regulatory compliance."
                    },
                    'data-privacy-security': { 
                        type: "ARRAY", 
                        items: { type: "OBJECT", properties: { filename: { type: "STRING" }, content: { type: "STRING" } } },
                        description: "List of generated files related to data privacy and security."
                    },
                    'customer-service-empathy': { 
                        type: "ARRAY", 
                        items: { type: "OBJECT", properties: { filename: { type: "STRING" }, content: { type: "STRING" } } },
                        description: "List of generated files related to customer service and empathy."
                    }
                },
                required: TEST_CATEGORIES
            };

            const fullSystemInstruction = `You are an expert in LLM test project scaffolding. Your task is to generate a complete set of Promptfoo files for the user's project goal. The final output must be a single, stringified JSON object conforming to the provided schema, where the top-level keys are the fixed test categories: ${TEST_CATEGORIES.join(', ')}.
            
            For each category, generate 1-3 relevant files (promptfooconfig.yaml, prompt.txt, and/or tests.csv) that would be used to test that specific aspect of the AI assistant. 
            
            Project Goal: ${prompt}
            
            Ensure all file contents are correctly formatted (YAML for config, plain text/CSV for others). For the 'content' field, include the complete file content as a single string.`;

            const payload = {
                contents: [{ parts: [{ text: `Generate a structured test project based on the following goal: ${prompt}` }] }],
                systemInstruction: { parts: [{ text: fullSystemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            try {
                // Use the API URL with the key provided by the user input
                const response = await fetch(API_URL_WITH_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`API Error: ${response.status} - ${response.statusText}\nDetails: ${errorDetails.substring(0, 200)}...`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) {
                    throw new Error("Received an empty or malformed JSON response from the model.");
                }

                generatedArtifacts = JSON.parse(jsonText);
                
                // Render the structured display
                renderProjectStructure(generatedArtifacts);
                
                // Format the raw output display (for detail/backup view)
                updateOutput(JSON.stringify(generatedArtifacts, null, 2));


                showStatus('Project artifacts successfully generated. Ready for download!', 'success');
                downloadButton.disabled = false;

            } catch (error) {
                console.error("Analysis failed:", error);
                updateOutput(`Error: ${error.message}`);
                showStatus(`Analysis failed: ${error.message}`, 'error');
                generatedArtifacts = null;
                downloadButton.disabled = true;
                hideProjectStructure();
            } finally {
                showLoading(false);
            }
        }

        // --- DOWNLOAD LOGIC (Now correctly combines content from all categories) ---

        function downloadArtifacts() {
            if (!generatedArtifacts) {
                showStatus('No artifacts generated to download.', 'error');
                return;
            }

            let zipContent = '--- GENERATED PROJECT ARTIFACTS ---\n\n';
            let totalFiles = 0;

            TEST_CATEGORIES.forEach(category => {
                const files = generatedArtifacts[category] || [];
                if (files.length > 0) {
                    zipContent += `\n\n### Folder: ${category} (${files.length} Files) ###\n`;
                    files.forEach(file => {
                        totalFiles++;
                        zipContent += `\n\n--- File: ${category}/${file.filename} ---\n`;
                        zipContent += file.content + '\n';
                    });
                }
            });
            
            console.log(`--- Simulating ZIP File Generation: ${totalFiles} total files ---`);
            showStatus(`Download simulated. Generating a single text file containing all ${totalFiles} artifacts.`, 'info');

            const blob = new Blob([zipContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'llm-project-artifacts-structured.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
