<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Project Artifact Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">LLM Project Artifact Generator</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Input Card (Updated) -->
            <div class="card p-6 rounded-xl col-span-2 space-y-5">
                
                <!-- NEW: Gemini API Key Input -->
                <div class="space-y-2">
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Paste your Gemini API Key here (starts with 'AIza...')" />
                </div>
                
                <div class="space-y-2">
                    <label for="promptInput" class="block text-sm font-medium text-gray-700">Project Prompt / Goal</label>
                    <textarea id="promptInput" rows="7" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., Write a 500-word essay about the impact of generative AI on creative jobs, focusing on artists and writers."></textarea>
                </div>

                <!-- Removed System Instruction Input -->
            </div>
            
            <!-- Actions/Output Card -->
            <div class="card p-6 rounded-xl space-y-5">
                <h2 class="text-xl font-semibold text-gray-800">Actions & Status</h2>

                <button id="analyzeButton" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50" onclick="handleAnalyzeProject()">
                    <span id="buttonText">Analyze & Structure Project</span>
                    <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                </button>

                <div id="statusMessage" class="min-h-12 p-3 text-sm rounded-lg border hidden transition duration-300"></div>

                <div class="space-y-2 pt-2">
                    <label class="block text-sm font-medium text-gray-700">Generated Output</label>
                    <!-- NEW: Project Structure Display -->
                    <div id="projectStructure" class="bg-gray-50 p-3 border border-gray-200 rounded-lg hidden space-y-2">
                        <p class="font-semibold text-sm">Project Goal:</p>
                        <p id="goalSummary" class="text-xs text-gray-600 mb-3"></p>
                        <p class="font-semibold text-sm">Generated Artifact Files:</p>
                        <div class="space-y-1">
                            <div class="p-2 bg-white border border-gray-100 rounded-lg flex justify-between text-xs">
                                <span class="font-mono text-gray-700">promptfooconfig.yaml</span>
                                <span class="text-indigo-600 font-medium">Config File</span>
                            </div>
                            <div class="p-2 bg-white border border-gray-100 rounded-lg flex justify-between text-xs">
                                <span class="font-mono text-gray-700">prompt.txt</span>
                                <span class="text-indigo-600 font-medium">Prompt Template</span>
                            </div>
                            <div class="p-2 bg-white border border-gray-100 rounded-lg flex justify-between text-xs">
                                <span class="font-mono text-gray-700">tests.csv</span>
                                <span class="text-indigo-600 font-medium">Test Cases</span>
                            </div>
                        </div>
                    </div>
                    <!-- OLD: Raw output display, now used as a fallback/detail view -->
                    <pre id="outputContent" class="bg-gray-50 p-3 h-40 overflow-auto border border-gray-200 rounded-lg text-xs whitespace-pre-wrap"></pre>
                </div>
                
                <button id="downloadButton" class="w-full py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 disabled:opacity-50" disabled onclick="downloadArtifacts()">Download Project (ZIP)</button>
            </div>
        </div>
    </div>

    <script>
        // Global constant for the model
        const GENERATION_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // --- DOM ELEMENTS ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const promptInput = document.getElementById('promptInput');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');
        const outputContent = document.getElementById('outputContent');
        const downloadButton = document.getElementById('downloadButton');
        
        // NEW DOM ELEMENTS
        const projectStructure = document.getElementById('projectStructure');
        const goalSummary = document.getElementById('goalSummary');


        let generatedArtifacts = null; // Stores the JSON structure for download

        // --- UI FUNCTIONS ---

        function showLoading(isLoading) {
            analyzeButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Analyzing...' : 'Analyze & Structure Project';
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-300', 'bg-green-100', 'text-green-700', 'border-green-300', 'bg-blue-100', 'text-blue-700', 'border-blue-300');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            } else {
                statusMessage.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }
        }

        function updateOutput(content) {
            outputContent.textContent = content;
        }

        function showProjectStructure(artifacts) {
            goalSummary.textContent = artifacts.projectGoal;
            projectStructure.classList.remove('hidden');
            outputContent.classList.remove('h-40');
            outputContent.classList.add('h-24'); // Make raw output smaller when structure is visible
        }
        
        function hideProjectStructure() {
            projectStructure.classList.add('hidden');
            outputContent.classList.remove('h-24');
            outputContent.classList.add('h-40');
        }


        // --- CORE LOGIC ---

        async function handleAnalyzeProject() {
            const prompt = promptInput.value.trim();
            const apiKey = apiKeyInput.value.trim(); // Read the API Key

            if (!apiKey) {
                showStatus('Please enter your Gemini API Key to run the analysis.', 'error');
                return;
            }

            if (!prompt) {
                showStatus('Please enter a project prompt/goal.', 'error');
                return;
            }

            // Construct API URL with user-provided key
            const API_URL_WITH_KEY = `https://generativelanguage.googleapis.com/v1beta/models/${GENERATION_MODEL}:generateContent?key=${apiKey}`;
            
            showLoading(true);
            updateOutput('Awaiting response from Gemini...');
            downloadButton.disabled = true;
            hideProjectStructure(); // Hide previous structure

            
            // Define the JSON schema for the desired output (Promptfoo structure)
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    projectGoal: { type: "STRING", description: "A concise summary of the LLM's goal." },
                    provider: { type: "STRING", description: "The default LLM provider ID for the generated config (e.g., openai:gpt-5-mini, vertex:gemini-2.5-flash)." },
                    config: { 
                        type: "STRING", 
                        description: "The complete content for the promptfooconfig.yaml file (YAML format). Use 'openai:gpt-5-mini' as the default provider." 
                    },
                    prompts: { type: "STRING", description: "The content for a sample prompt file (e.g., prompt.txt or prompt.yaml)." },
                    tests: { type: "STRING", description: "The content for a sample test file (e.g., tests.csv or tests.yaml)." }
                },
                required: ["projectGoal", "provider", "config", "prompts", "tests"]
            };

            // Simplified System Instruction (no optional user-defined system prompt)
            const fullSystemInstruction = `You are an expert in LLM evaluation using the Promptfoo framework. Your task is to generate the necessary scaffolding files (YAML config, a sample prompt, and a sample test file) for the user's project goal. The final output must be a single, stringified JSON object conforming to the provided schema. The 'config' value must use 'openai:gpt-5-mini' as the default provider for portability, regardless of the user's prompt. 
            
            Project Goal: ${prompt}
            
            Generate the content for the following files based on the project goal:
            1. 'promptfooconfig.yaml': The main configuration file.
            2. 'prompt.txt': A file containing the prompt template.
            3. 'tests.csv': A file containing the test variables.
            
            Ensure the 'config' field contains valid, correctly formatted YAML content as a single string. Do not include markdown formatting (e.g., \`\`\`yaml) within the config string itself.`;

            const payload = {
                contents: [{ parts: [{ text: `Generate Promptfoo scaffolding for the project described above.` }] }],
                systemInstruction: { parts: [{ text: fullSystemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            try {
                // Use the API URL with the key provided by the user input
                const response = await fetch(API_URL_WITH_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorDetails.substring(0, 100)}...`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) {
                    throw new Error("Received an empty or malformed JSON response from the model.");
                }

                generatedArtifacts = JSON.parse(jsonText);
                
                // Format the raw output display (as a detail/backup view)
                const displayContent = `Project Goal: ${generatedArtifacts.projectGoal}\n\n--- promptfooconfig.yaml ---\n${generatedArtifacts.config}\n\n--- prompt.txt ---\n${generatedArtifacts.prompts}\n\n--- tests.csv ---\n${generatedArtifacts.tests}`;

                updateOutput(displayContent);
                showProjectStructure(generatedArtifacts); // Show the new structured display
                showStatus('Project artifacts successfully generated. Ready for download!', 'success');
                downloadButton.disabled = false;

            } catch (error) {
                console.error("Analysis failed:", error);
                updateOutput(`Error: ${error.message}`);
                showStatus(`Analysis failed: ${error.message}`, 'error');
                generatedArtifacts = null;
                downloadButton.disabled = true;
                hideProjectStructure();
            } finally {
                showLoading(false);
            }
        }

        // --- DOWNLOAD LOGIC (Uses a simple mock Zip functionality for demonstration) ---

        function downloadArtifacts() {
            if (!generatedArtifacts) {
                showStatus('No artifacts generated to download.', 'error');
                return;
            }

            // This function simulates downloading a ZIP by logging file contents and simulating a link click.
            console.log("--- Simulating ZIP File Generation ---");
            console.log("File 1: promptfooconfig.yaml\n", generatedArtifacts.config);
            console.log("File 2: prompt.txt\n", generatedArtifacts.prompts);
            console.log("File 3: tests.csv\n", generatedArtifacts.tests);
            console.log("-------------------------------------");

            showStatus("Download simulated. Please check the 'Generated Output' for artifact content.", 'info');

            // Actual file creation/download logic would go here.
            // Since we cannot generate multiple files or ZIPs in this environment, 
            // we will create a text file containing all artifacts for review.
            
            const zipContent = 
`--- Project Goal ---
${generatedArtifacts.projectGoal}

--- promptfooconfig.yaml ---
${generatedArtifacts.config}

--- prompt.txt ---
${generatedArtifacts.prompts}

--- tests.csv ---
${generatedArtifacts.tests}`;

            const blob = new Blob([zipContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'llm-project-artifacts.txt'; // Download as a single text file for simplicity
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
