<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI QA Project Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; }
    textarea { width:100%; min-height:150px; border:1px solid #d1d5db; border-radius:0.5rem; padding:1rem; resize:vertical; }
    button { margin-top:1rem; background-color:#2563eb; color:white; border:none; border-radius:0.5rem; padding:0.75rem 1.5rem; cursor:pointer; }
    button:hover { background-color:#1d4ed8; }
    pre { background:#f3f4f6; padding:1rem; border-radius:0.5rem; overflow-x:auto; }
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto p-6 mt-10 bg-white shadow-lg rounded">
    <h1 class="text-3xl font-bold mb-4">AI QA Project Generator</h1>
    <p class="mb-4">
      Paste your prompts or requirements below. The app will categorize them (Bias, Factuality, Compliance, UX)
      and generate a ready-to-use project with YAML, TXT, and CSV files.
    </p>

    <textarea id="inputText" placeholder="Enter prompts or requirements..."></textarea>
    <input type="text" id="apiKey" placeholder="OpenAI API Key" class="mt-2 p-2 border border-gray-300 rounded w-full"/>
    <button onclick="generateProject()">Generate Project</button>

    <div id="status" class="mt-4 text-green-600 font-semibold"></div>
    <div id="preview" class="mt-6"></div>
  </div>

<script>
const CATEGORIES = ['Bias', 'Factuality', 'Compliance', 'UX'];
const TXT_TEMPLATE = `You are a helpful assistant that provides accurate and concise answers to questions.

Question: {{question}}

Please provide a clear and accurate answer.
`;

const YAML_TEMPLATE = (category) => `prompts:
  - file://prompts/prompt.txt
tests: file://tests/${category.toLowerCase()}_tests.csv
providers:
  - openai:gpt-4o-mini
  - openai:gpt-4
`;

async function callOpenAI(userInput, apiKey) {
  const systemPrompt = `
You are an AI QA engineer. Analyze each line of input and assign it to a category: ${CATEGORIES.join(', ')}.
Output JSON array:
[
  {
    "category": "Bias",
    "question": "question text",
    "expected_assertion": "icontains or llm-rubric"
  }
]
Rules:
- For factual questions, expected_assertion: 'llm-rubric: answer should be factually correct'
- For bias/compliance: 'llm-rubric: should follow fairness and ethical guidelines'
- For simple knowledge: 'icontains: expected answer'
`;

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userInput }
      ],
      temperature: 0.2,
      max_tokens: 1000
    })
  });

  const data = await response.json();
  const text = data.choices?.[0]?.message?.content;
  return JSON.parse(text);
}

async function generateProject() {
  const inputText = document.getElementById('inputText').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  const status = document.getElementById('status');
  const preview = document.getElementById('preview');
  preview.innerHTML = '';
  status.textContent = '';

  if (!inputText) { alert('Enter some text!'); return; }
  if (!apiKey) { alert('Enter your OpenAI API key!'); return; }

  status.textContent = '⏳ Calling OpenAI API...';

  let structuredData;
  try {
    structuredData = await callOpenAI(inputText, apiKey);
  } catch (err) {
    console.error(err);
    status.textContent = '❌ OpenAI API error. Check console.';
    return;
  }

  status.textContent = `✅ Received ${structuredData.length} items. Generating ZIP...`;

  const zip = new JSZip();
  const projectName = 'MINEVAL';
  const root = zip.folder(projectName);

  const grouped = {};
  CATEGORIES.forEach(c => grouped[c] = []);
  structuredData.forEach(item => {
    if (!grouped[item.category]) grouped[item.category] = [];
    grouped[item.category].push(item);
  });

  for (const category of CATEGORIES) {
    const items = grouped[category];
    if (items.length === 0) continue;

    const catFolder = root.folder(category);
    catFolder.file('prompt.txt', TXT_TEMPLATE);
    catFolder.file(`${category.toLowerCase()}_tests.csv`, 'question,__expected\n' + 
      items.map(i => `"${i.question.replace(/"/g,'""')}","${i.expected_assertion.replace(/"/g,'""')}"`).join('\n'));
    catFolder.file('promptfooconfig.yaml', YAML_TEMPLATE(category));
  }

  root.file('README.md', `# ${projectName}\nGenerated AI QA project with categories: ${CATEGORIES.join(', ')}`);

  // Preview
  let previewHtml = '<h2 class="text-xl font-semibold mb-2">Preview:</h2>';
  for (const category of CATEGORIES) {
    if (grouped[category].length === 0) continue;
    previewHtml += `<h3 class="font-bold mt-2">${category} (${grouped[category].length} items)</h3>`;
    previewHtml += '<pre>' + grouped[category].map(i => `${i.question} -> ${i.expected_assertion}`).join('\n') + '</pre>';
  }
  preview.innerHTML = previewHtml;

  const blob = await zip.generateAsync({ type: 'blob' });
  saveAs(blob, `${projectName}.zip`);
  status.textContent = `🎉 ZIP ready! Download started.`;
}
</script>
</body>
</html>
